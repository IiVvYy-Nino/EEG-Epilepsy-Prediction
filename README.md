# ğŸ§  EEG-Epilepsy-Prediction

**å¤šå°ºåº¦æ³¨æ„åŠ›BiLSTMçš„EEGç™«ç—«å‘ä½œæ£€æµ‹ä¸åˆ†å‹æ¡†æ¶**

é›†æˆ**é€šé“æ³¨æ„åŠ›**ã€**æ—¶é—´æ³¨æ„åŠ›**å’Œ**åŒå‘LSTM**çš„ç«¯åˆ°ç«¯æ·±åº¦å­¦ä¹ æ¡†æ¶ã€‚ç«¯åˆ°ç«¯æµç¨‹ï¼šEDF è¯»å– â†’ é¢‘å¸¦/æ—¶åŸŸç‰¹å¾ â†’ ğŸ§ **å¤šå°ºåº¦æ³¨æ„åŠ›BiLSTM** å¸§çº§å¤šåˆ†ç±» â†’ äº‹ä»¶çº§åå¤„ç†ï¼ˆå¹³æ»‘/ç¡®è®¤/å†·å´/æœ€å°æ—¶é•¿ï¼‰â†’ æŒ‡æ ‡è¯„ä¼°ä¸é˜ˆå€¼ç½‘æ ¼æœç´¢ï¼ˆFA/h çº¦æŸï¼Œè‡ªåŠ¨å†™å›é…ç½®ï¼‰ã€‚

**ğŸ¯ åˆ›æ–°ç‰¹æ€§**: æ³¨æ„åŠ›æƒé‡å¯è§†åŒ– | å†…å­˜ä¼˜åŒ–è®¾è®¡ | LOSOCVäº¤å‰éªŒè¯ | ç«¯åˆ°ç«¯è®­ç»ƒæ¨ç†

---

## ä¸€ã€æ•´ä½“æ¶æ„ä¸æ€è·¯åŸç†

- æ•°æ®å±‚ï¼ˆ`src/edf_reader.py`ï¼‰
  - ä½¿ç”¨ `pyedflib` é€é€šé“è¯»å– EDFï¼›å»ç›´æµï¼ˆé›¶å‡å€¼ï¼‰ï¼›å¯é€‰å·¥é¢‘é™·æ³¢ï¼ˆ50/60Hzï¼‰ï¼Œå¯é€‰å¸¦é€š/é«˜é€š/ä½é€šï¼›ç»Ÿä¸€é‡é‡‡æ ·åˆ° `resample_hz`ï¼›å°†ä¸åŒé•¿åº¦çš„é€šé“è£å‰ªåˆ°ç›¸åŒæœ€å°é•¿åº¦å¹¶å †å ä¸º `[C, N]`ã€‚
- ç‰¹å¾å±‚ï¼ˆ`src/features.py`ï¼‰
  - ä»¥æ»‘çª—å‚æ•° `window_sec/hop_sec` è®¡ç®— Welch PSDï¼Œèšåˆé¢‘å¸¦åŠŸç‡ï¼ˆdelta/theta/alpha/beta/gammaï¼‰ï¼Œå¯¹é€šé“åš {mean, std}ï¼›å†åŠ å…¥å®½é¢‘èƒ½é‡ {mean, std} ä¸æ—¶åŸŸ RMS {mean, std} â†’ å¾—åˆ°é€å¸§ç‰¹å¾ `[T, F]` å’Œå¸§ä¸­å¿ƒæ—¶é—´ `centers`ã€‚
- æ¨¡å‹å±‚ï¼ˆ`src/model.py`ï¼‰- **ğŸ§  å¤šå°ºåº¦æ³¨æ„åŠ›BiLSTMæ¶æ„**
  - **é€šé“æ³¨æ„åŠ›**: è‡ªé€‚åº”é€‰æ‹©é‡è¦çš„EEGé¢‘å¸¦ç‰¹å¾ï¼Œçªå‡ºç—…ç†è„‘åŒºæ´»åŠ¨
  - **åŒå‘LSTM**: æå–æ—¶åºä¸Šä¸‹æ–‡ï¼Œæ•æ‰ç™«ç—«å‘ä½œçš„å‰åæ—¶åºä¾èµ–
  - **æ—¶é—´æ³¨æ„åŠ›**: å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œä¸“æ³¨äºç™«ç—«å‘ä½œå…³é”®æ—¶åˆ»
  - **åˆ†ç±»å™¨**: å¤šå±‚å…¨è¿æ¥ç½‘ç»œï¼Œè¾“å‡ºå¸§çº§ logits `[B,T,C]`ï¼›æŸå¤±ä¸ºäº¤å‰ç†µï¼ˆå¿½ç•¥æ ‡ç­¾å€¼ -100ï¼‰
  - è®­ç»ƒæ”¯æŒå­¦ä¹ ç‡è°ƒåº¦ï¼ˆCosine/OneCycleLRï¼‰ã€å¢å¼ºï¼ˆMixup/SpecAugment/å™ªå£°ï¼‰ã€æ¢¯åº¦è£å‰ªï¼Œæå‡æ³›åŒ–ä¸ç¨³å®šæ€§
- åå¤„ç†ï¼ˆ`src/postprocess.py`ï¼‰
  - åŸºäº `1 - p(bckg)`ï¼šå¹³æ»‘ï¼ˆç§»åŠ¨å¹³å‡ï¼‰â†’ é˜ˆå€¼äºŒå€¼åŒ– â†’ è¿ç»­ç¡®è®¤çª—ï¼ˆconfirmï¼‰â†’ ç›¸é‚»ç‰‡æ®µå†·å´æ—¶é—´åˆå¹¶ï¼ˆcooldownï¼‰â†’ æœ€å°äº‹ä»¶æ—¶é•¿è¿‡æ»¤ï¼›ç‰‡æ®µå†…æŒ‰æ¦‚ç‡å’Œï¼ˆæˆ–æœ€å¤§ï¼‰é€‰ä¸»ç±»ä¸ç½®ä¿¡ã€‚
- è¯„ä¼°ä¸é˜ˆå€¼ï¼ˆ`src/metrics.py`ã€`src/scan_thresholds.py`ã€`src/eval.py`ï¼‰
  - äº‹ä»¶çº§ IoU åŒ¹é…ï¼šè®¡ç®— P/R/F1ã€FA/hã€èµ·æ­¢å»¶è¿Ÿï¼›é˜ˆå€¼ç½‘æ ¼æœç´¢åœ¨ FA/h çº¦æŸä¸‹é€‰æœ€ä½³ï¼Œå¹¶è‡ªåŠ¨å†™å› `configs/config.yaml`ã€‚

æµç¨‹ï¼š

```
EDF files
  â””â”€> edf_reader (filter / notch / resample / align)
        â””â”€> features (Welch PSD bands + RMS)
              â””â”€> ğŸ§  Multi-Scale Attention BiLSTM
                    â”œâ”€> Channel Attention (é¢‘å¸¦é€‰æ‹©)
                    â”œâ”€> BiLSTM (æ—¶åºå»ºæ¨¡)
                    â”œâ”€> Temporal Attention (å…³é”®æ—¶åˆ»èšç„¦)
                    â””â”€> Classifier (å¸§çº§åˆ†ç±»)
                          â”œâ”€> postprocess (smooth / confirm / cooldown / min_dur) -> events
                          â”œâ”€> metrics (PR/F1, FA/h, latencies)
                          â””â”€> threshold grid search (constraints + writeback)
```

---

## äºŒã€å®‰è£…ä¸ç¯å¢ƒ

- Python 3.11+ï¼ˆå»ºè®®è™šæ‹Ÿç¯å¢ƒ conda/venvï¼‰

### ğŸ”§ **æ¨èå®‰è£…æ–¹å¼**

```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
conda create -n EEG_work python=3.11
conda activate EEG_work

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. éªŒè¯å®‰è£…
python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.cuda.is_available()}')"
```

### ğŸªŸ **Windowsç”¨æˆ·ç‰¹åˆ«è¯´æ˜**

- **ç¯å¢ƒæ¿€æ´»**: æ¯æ¬¡ä½¿ç”¨å‰éœ€è¦æ¿€æ´»ç¯å¢ƒï¼š`conda activate EEG_work`
- **å‘½ä»¤è¡Œè¯­æ³•**: Windows PowerShellä¸æ”¯æŒ`\`ç»­è¡Œï¼Œè¯·ä½¿ç”¨å•è¡Œå‘½ä»¤æˆ–``(åå¼•å·)ç»­è¡Œ
- **ä¸­æ–‡æ”¯æŒ**: ç¡®ä¿æ–‡ä»¶ä¿å­˜ä¸º UTF-8ï¼Œä½¿ç”¨PowerShellé¿å…ä¹±ç 

### ğŸš¨ **OOMå†…å­˜æº¢å‡ºä¿®å¤**

**æœ¬é¡¹ç›®å·²å†…ç½®OOMä¿æŠ¤æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š**
- âœ… æ™ºèƒ½åºåˆ—é•¿åº¦é™åˆ¶ï¼ˆæœ€å¤§8000å¸§ï¼Œçº¦33åˆ†é’Ÿï¼‰
- âœ… åŠ¨æ€å†…å­˜æ£€æŸ¥å’Œè‡ªåŠ¨æˆªæ–­
- âœ… æ¢¯åº¦ç´¯ç§¯æ”¯æŒï¼ˆæ¨¡æ‹Ÿå¤§æ‰¹æ¬¡æ•ˆæœï¼‰
- âœ… å†…å­˜ä¼˜åŒ–çš„æ‰¹å¤„ç†å‡½æ•°
- âœ… GPUå†…å­˜ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†

**å¦‚æœä»é‡åˆ°OOMï¼Œå¯è¿›ä¸€æ­¥è°ƒæ•´ï¼š**
```bash
# æœ€ä¿å®ˆé…ç½®ï¼ˆé€‚ç”¨äº8GBå†…å­˜ï¼‰
python -m src.train --batch_size 1 --gradient_accumulation_steps 4 --num_workers 0
```

---

## ä¸‰ã€æ•°æ®ç»„ç»‡ä¸ç¼“å­˜

- æ•°æ®é›†å‚è€ƒï¼šTUSZï¼ˆTemple University Hospital Seizure Corpusï¼Œè§å®˜ç½‘æ–‡æ¡£ï¼‰ã€‚
  - å®˜æ–¹ä¸»é¡µï¼š`https://www.isip.piconepress.com/projects/tuh_eeg/html/downloads.shtml`

- å°† EDF ä¸åŒå TSE æ”¾å…¥ `data/Dataset_train_dev/`ï¼ŒTSE è¡Œç¤ºä¾‹ï¼š
  - `0.0000 36.8868 bckg 1.0000`ï¼ˆå¼€å§‹ç§’ ç»“æŸç§’ æ ‡ç­¾ ç½®ä¿¡ï¼›ç½®ä¿¡å¯ç¼ºçœï¼‰
- ç›®å½•ç¤ºä¾‹ï¼š

```
data/
  Dataset_train_dev/
    00000001_s001_t000.edf
    00000001_s001_t000.tse
    ...
```

- é¦–æ¬¡è¿è¡Œä¼šåœ¨ `data_cache/` ç”Ÿæˆ `.npz` ç‰¹å¾ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æµç¨‹ã€‚
- `.gitignore` å·²å¿½ç•¥ï¼š`data/`, `data_cache/`, `outputs/`, `__pycache__/`ã€‚

---

## å››ã€å†…å­˜ä¼˜åŒ–é…ç½® ğŸš€

æœ¬é¡¹ç›®å·²é’ˆå¯¹GPUå†…å­˜è¿›è¡Œæ·±åº¦ä¼˜åŒ–ï¼Œæ”¯æŒåœ¨è¾ƒå°æ˜¾å­˜ç¯å¢ƒä¸‹è¿è¡Œï¼š

### ğŸ“Š **æ¨¡å‹å‚æ•°ä¼˜åŒ–**
- **åŸå§‹é…ç½®**: ~4.93M å‚æ•°ï¼Œè®­ç»ƒå†…å­˜ ~56MB
- **ä¼˜åŒ–é…ç½®**: ~0.85M å‚æ•°ï¼Œè®­ç»ƒå†…å­˜ ~10MB (å‡å°‘82.8%)

### ğŸ”§ **å…³é”®ä¼˜åŒ–æªæ–½**
```yaml
# ğŸ§  æ³¨æ„åŠ›æœºåˆ¶æ¨¡å‹æ¶æ„ä¼˜åŒ–
hidden_dim: 128      # LSTMéšè—å±‚ç»´åº¦ï¼ˆä»256å‡å°‘åˆ°128ï¼‰
num_layers: 2        # LSTMå±‚æ•°ï¼ˆä»3å‡å°‘åˆ°2ï¼‰
attention_heads: 4   # å¤šå¤´æ³¨æ„åŠ›æ•°é‡ï¼ˆä»8å‡å°‘åˆ°4ï¼‰
use_attention: true  # å¯ç”¨å¤šå°ºåº¦æ³¨æ„åŠ›æœºåˆ¶

# è®­ç»ƒä¼˜åŒ–
batch_size: 1                    # æå°æ‰¹å¤„ç†
gradient_accumulation_steps: 8   # æ¢¯åº¦ç´¯ç§¯ä¿æŒç­‰æ•ˆæ‰¹å¤§å°
num_workers: 0                   # å‡å°‘å¤šè¿›ç¨‹å¼€é”€
precompute_cache: none          # å…³é—­é¢„è®¡ç®—ç¼“å­˜
```

### ğŸ’¾ **æ˜¾å­˜ä½¿ç”¨å¯¹æ¯”**
| é…ç½® | RTX 4060 (8GB) | RTX 3090 (24GB) |
|------|----------------|------------------|
| åŸå§‹ | OOM âŒ | æ­£å¸¸ âœ… |
| ä¼˜åŒ– | æ­£å¸¸ âœ… | å¿«é€Ÿ ğŸš€ |

### ğŸ¯ **é€‚ç”¨åœºæ™¯**
- âœ… RTX 4060/4070 ç­‰8GBæ˜¾å¡
- âœ… å­¦ä¹ ç ”ç©¶ç¯å¢ƒ
- âœ… èµ„æºå—é™åœºæ™¯
- ğŸš€ RTX 3090/4090 é«˜ç«¯æ˜¾å¡å¯è·å¾—æ›´å¿«è®­ç»ƒé€Ÿåº¦

---

## äº”ã€ğŸ§  æ³¨æ„åŠ›æœºåˆ¶æ¶æ„è¯¦è§£

æœ¬é¡¹ç›®å®ç°äº†ä¸“ä¸ºEEGç™«ç—«æ£€æµ‹è®¾è®¡çš„**å¤šå°ºåº¦æ³¨æ„åŠ›BiLSTMæ¶æ„**ï¼Œé€šè¿‡ä¸‰å±‚æ³¨æ„åŠ›æœºåˆ¶æå‡æ£€æµ‹ç²¾åº¦ï¼š

### ğŸ“¡ **1. é€šé“æ³¨æ„åŠ› (Channel Attention)**
```python
# è‡ªé€‚åº”é€‰æ‹©é‡è¦çš„EEGé¢‘å¸¦ç‰¹å¾
- è¾“å…¥: [B, T, F] EEGç‰¹å¾
- åŠŸèƒ½: çªå‡ºç—…ç†è„‘åŒºçš„é¢‘è°±æ´»åŠ¨
- å®ç°: å…¨å±€æ± åŒ– + FCå±‚ + Sigmoidæ¿€æ´»
- è¾“å‡º: ç‰¹å¾åŠ æƒåçš„è¡¨ç¤º
```

### â° **2. æ—¶é—´æ³¨æ„åŠ› (Temporal Attention)**  
```python
# å¤šå¤´è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œèšç„¦ç™«ç—«å‘ä½œå…³é”®æ—¶åˆ»
- è¾“å…¥: [B, T, H] LSTMéšè—çŠ¶æ€
- åŠŸèƒ½: æ•æ‰é•¿è·ç¦»æ—¶åºä¾èµ–ï¼Œä¸“æ³¨å‘ä½œèµ·å§‹
- å®ç°: Multi-Head Self-Attention + æ®‹å·®è¿æ¥
- å¤´æ•°: 4ä¸ªæ³¨æ„åŠ›å¤´ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰
```

### ğŸ§¬ **3. BiLSTMéª¨å¹²ç½‘ç»œ**
```python
# åŒå‘LSTMæå–æ—¶åºä¸Šä¸‹æ–‡
- å±‚æ•°: 2å±‚ï¼ˆå¹³è¡¡æ€§èƒ½ä¸æ•ˆç‡ï¼‰
- éšè—å±‚: 128ç»´ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰
- åŒå‘: åŒæ—¶å»ºæ¨¡è¿‡å»å’Œæœªæ¥ä¿¡æ¯
- Dropout: 0.15é˜²æ­¢è¿‡æ‹Ÿåˆ
```

### ğŸ¯ **æ¶æ„ä¼˜åŠ¿**
- **ğŸ” ç²¾å‡†å®šä½**: é€šé“æ³¨æ„åŠ›çªå‡ºå¼‚å¸¸é¢‘å¸¦
- **â±ï¸ æ—¶åºå»ºæ¨¡**: æ—¶é—´æ³¨æ„åŠ›æ•æ‰å‘ä½œæ—¶åºæ¨¡å¼  
- **ğŸ’¡ ç«¯åˆ°ç«¯**: æ³¨æ„åŠ›æƒé‡å¯è§†åŒ–ï¼Œæä¾›å¯è§£é‡Šæ€§
- **âš¡ é«˜æ•ˆ**: å†…å­˜ä¼˜åŒ–è®¾è®¡ï¼Œé€‚é…8GBæ˜¾å¡

### ğŸ“Š **æ³¨æ„åŠ›å¯è§†åŒ–**
è®­ç»ƒè¿‡ç¨‹ä¸­æ¨¡å‹ä¼šè¾“å‡ºæ³¨æ„åŠ›æƒé‡ï¼Œå¯ç”¨äºï¼š
- åˆ†æå“ªäº›é¢‘å¸¦å¯¹æ£€æµ‹æœ€é‡è¦
- å¯è§†åŒ–ç™«ç—«å‘ä½œçš„æ—¶åºæ¨¡å¼
- æä¾›ä¸´åºŠå¯è§£é‡Šçš„è¯Šæ–­ä¾æ®

---

## å…­ã€å¿«é€Ÿä¸Šæ‰‹ï¼ˆé€æ­¥æ“ä½œï¼‰

1) å‡†å¤‡æ•°æ®

- æŒ‰ä¸ŠèŠ‚æ”¾å¥½ EDF/TSEï¼›ç¡®ä¿ `pyedflib` å¯æ­£å¸¸è¯»å– EDFã€‚

2) é…ç½®

- ç¼–è¾‘ `configs/config.yaml` çš„ `train`ã€`postprocess`ã€`labels` ä¸‰èŠ‚ï¼›æˆ–ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°è¦†ç›–ã€‚
  - å¦‚éœ€å¤šç±»åˆ«æ£€æµ‹/åˆ†å‹ï¼Œè¯·æä¾›ä¸¤å¼  Excelï¼ˆç¤ºä¾‹å­—æ®µï¼šè§„èŒƒå/åˆ«åï¼‰ï¼Œè®­ç»ƒä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶ä½¿ç”¨ `outputs/labels.json`ï¼›
  - è®­ç»ƒå‰ä¼šè¿›è¡Œâ€œç±»åˆ«ä¸€è‡´æ€§â€å‰ç½®æ ¡éªŒï¼Œ`.tse` ä¸­çš„æ ‡ç­¾å¿…é¡»è¢« Excel å®šä¹‰çš„æ ‡ç­¾/åˆ«åè¦†ç›–ã€‚

3) åˆ’åˆ†ä¸è®­ç»ƒ

3.1 å›ºå®šåˆ’åˆ†ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰

```bash
python -m src.split \
  --data_dir data/Dataset_train_dev \
  --out outputs/splits.json --val_ratio 0.2 --test_ratio 0.2 --seed 42
```

3.2 è®­ç»ƒï¼ˆæ¨èé…ç½®ï¼Œå·²ä¼˜åŒ–OOMé—®é¢˜ï¼‰

### ğŸš€ **å¿«é€Ÿå¼€å§‹è®­ç»ƒ**

```bash
# æ¿€æ´»ç¯å¢ƒï¼ˆWindowsç”¨æˆ·å¿…é¡»ï¼‰
conda activate EEG_work

# æ ‡å‡†è®­ç»ƒï¼ˆå·²æ·±åº¦ä¼˜åŒ–å†…å­˜ä½¿ç”¨ï¼‰
python -m src.train --config configs/config.yaml
```

### ğŸ”§ **è‡ªå®šä¹‰å‚æ•°è®­ç»ƒ**

```bash
# Windows PowerShell å•è¡Œç‰ˆæœ¬ï¼ˆå†…å­˜ä¼˜åŒ–é…ç½®ï¼‰
python -m src.train --config configs/config.yaml --scheduler onecycle --epochs 10 --batch_size 1 --progress bar

# Linux/Mac å¤šè¡Œç‰ˆæœ¬
python -m src.train --config configs/config.yaml \
  --scheduler onecycle --epochs 10 \
  --batch_size 1 --progress bar
```

### ğŸ“Š **ç›‘æ§è®­ç»ƒè¿‡ç¨‹**

- **TensorBoard**: `tensorboard --logdir outputs/tb`
- **è®­ç»ƒæ—¥å¿—**: `outputs/train.log`
- **æœ€ä½³æ¨¡å‹**: `outputs/best.pt`

3.3 LOSOCVï¼ˆæŒ‰å—è¯•è€…ç•™ä¸€äº¤å‰éªŒè¯ï¼Œæ”¯æŒæ–­ç‚¹ç»­è®­ï¼‰

### ğŸ”„ **LOSOCVè®­ç»ƒå‘½ä»¤ï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰**

```bash
# Windows PowerShell ç‰ˆæœ¬ï¼ˆæ¨èï¼Œå·²ä¼˜åŒ–å†…å­˜ï¼‰
python -m src.losocv --config configs/config.yaml --run_train --auto_optimize --opt_trials 5 --opt_epochs 2 --epochs 10 --batch_size 1 --resume --progress bar

# Linux/Mac ç‰ˆæœ¬
python -m src.losocv --run_train --auto_optimize \
  --config configs/config.yaml \
  --opt_trials 5 --opt_epochs 2 \
  --epochs 10 --batch_size 1 \
  --resume --progress bar
```

### âš¡ **å¿«é€Ÿæµ‹è¯•LOSOCV**

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆå‡ åˆ†é’Ÿå®Œæˆï¼Œå†…å­˜å‹å¥½ï¼‰
python -m src.losocv --config configs/config.yaml --run_train --epochs 2 --batch_size 1 --progress bar
```

### ğŸ”„ **æ–­ç‚¹ç»­è®­ç‰¹æ€§**

- âœ… **è‡ªåŠ¨æ£€æµ‹**: ä½¿ç”¨`--resume`å‚æ•°è‡ªåŠ¨ä»ä¸­æ–­ç‚¹ç»§ç»­
- âœ… **foldçº§åˆ«ç»­è®­**: æ¯ä¸ªæ‚£è€…foldå•ç‹¬ä¿å­˜ï¼Œæ”¯æŒéƒ¨åˆ†å®Œæˆåç»­è®­
- âœ… **åŒå±‚ç»­è®­**: æ”¯æŒOptunaè¯•éªŒçº§åˆ«å’Œæœ€ç»ˆè®­ç»ƒçš„æ–­ç‚¹ç»­è®­
- âœ… **è¿›åº¦æŸ¥çœ‹**: 
  ```bash
  # æŸ¥çœ‹å®Œæˆçš„foldæ•°é‡
  ls outputs/losocv/fold_*/best.pt
  # æŸ¥çœ‹æ€»foldæ•°
  ls outputs/losocv/*.json
  ```

- æ¯æŠ˜ä¼šï¼š
  - ç”Ÿæˆè¯¥æŠ˜çš„ `train/val/test` åˆ’åˆ† JSONï¼ˆtest ä¸ºè¢«ç•™å‡ºçš„å—è¯•è€…ï¼›å…¶ä½™æŒ‰â€œæ‚£è€…çº§å¤šç±»åˆ«åˆ†å±‚â€åˆ‡åˆ† train/valï¼‰
  - Optuna å¯»ä¼˜å¸§æ ‡æ³¨å‚æ•°ï¼ˆ`label_overlap_ratio`ã€`min_seg_duration`ï¼‰ï¼ŒçŸ­è®­è¯„ä¼°æŒ‘æœ€ä¼˜
  - ç”¨æœ€ä¼˜å‚æ•°è®­ç»ƒè¯¥æŠ˜æœ€ç»ˆæ¨¡å‹ï¼ˆå†™å…¥ `outputs/losocv/fold_<PID>/best.pt`ï¼‰
  - è¯„ä¼°è¯¥æŠ˜ testï¼Œå†™å…¥ `eval_summary.json` / `eval_records.csv`
  - è®­ç»ƒä¸è¯„ä¼°æ—¥å¿—è¾“å‡ºæ›´ç²¾ç®€æ˜“è¯»ï¼ˆæ§åˆ¶å°ä¸ `train.log`ï¼‰

- å…¨éƒ¨æŠ˜å®Œæˆåè‡ªåŠ¨æ±‡æ€»ï¼š
  - `outputs/losocv/loso_eval_aggregate.json`
  - ç»™å‡ºâ€œå®å¹³å‡ï¼ˆç®€å•å¹³å‡ï¼‰â€ä¸â€œå¾®å¹³å‡ï¼ˆæŒ‰ TP/FP/FN ä¸æ—¶é•¿èšåˆï¼‰â€ä¸¤å¥—æŒ‡æ ‡ï¼ˆä¼˜å…ˆæŸ¥çœ‹ IoU=0.5ï¼‰

4) é˜ˆå€¼ç½‘æ ¼ï¼ˆFA/h çº¦æŸ + å†™å›é…ç½®ï¼‰

```
python -m src.scan_thresholds \
  --data_dir data/Dataset_train_dev --cache_dir data_cache \
  --probs 0.6 0.7 0.8 0.9 --smooth 0.0 0.25 \
  --confirm 1 2 3 --cooldown 0.0 0.5 1.0 \
  --min_duration 0.0 --max_fa_per_hour 2.0 \
  --labels_json outputs/labels.json \
  --out outputs/threshold_grid.json --write_config configs/config.yaml
```

- è¾“å‡ºï¼š`outputs/threshold_grid.json`ï¼›å°†æœ€ä½³é˜ˆå€¼å†™å› `configs/config.yaml:postprocess`ã€‚
 - è¯´æ˜ï¼šè„šæœ¬å½“å‰æœªåŠ è½½ checkpointï¼Œä½¿ç”¨éšæœºåˆå§‹åŒ–æ¨¡å‹è¿›è¡Œæ¼”ç¤ºæ€§æ‰«æï¼Œä¸»è¦å±•ç¤ºâ€œé˜ˆå€¼-æŒ‡æ ‡-å†™å›â€çš„æµç¨‹ã€‚å®é™…ä½¿ç”¨ä¸­å»ºè®®åŸºäºå·²è®­ç»ƒæ¨¡å‹è¿›è¡Œé˜ˆå€¼é€‰æ‹©ï¼ˆå¯è‡ªè¡Œæ‰©å±•è„šæœ¬ä»¥åŠ è½½æƒé‡ï¼‰ï¼Œå¹¶å§‹ç»ˆæä¾› `--labels_json` ä»¥ä¿è¯ç±»åˆ«é›†åˆä¸€è‡´ã€‚

5) è¯„ä¼°ï¼ˆä» checkpointï¼‰

```
python -m src.eval --config configs/config.yaml --checkpoint outputs/best.pt \
  --labels_json outputs/labels.json
```

- è¾“å‡ºï¼š
  - `outputs/eval_summary.json`ï¼ˆå¤š IoU å…¨å±€æŒ‡æ ‡ï¼‰
  - `outputs/eval_records.csv`ï¼ˆé€è®°å½• TP/FP/FN ä¸èµ·æ­¢å»¶è¿Ÿï¼‰
 - æç¤ºï¼š`labels.json` çš„ç±»åˆ«é¡ºåºéœ€ä¸è®­ç»ƒæ—¶ä¸€è‡´ï¼Œä¸”éœ€ä¸ checkpoint åˆ†ç±»å¤´çš„ç±»åˆ«æ•°ç›¸åŒ¹é…ï¼Œå¦åˆ™è„šæœ¬ä¼šæŠ¥é”™ã€‚

- é’ˆå¯¹æŸä¸€æŠ˜è¿›è¡Œè¯„ä¼°ï¼ˆä»…è¯¥æŠ˜ testï¼‰ï¼š
```bash
python -m src.eval --config configs/config.yaml \
  --checkpoint outputs/losocv/fold_<PID>/best.pt \
  --splits_json outputs/losocv/<PID>.json --use_split test \
  --out_json outputs/losocv/fold_<PID>/eval_summary.json \
  --out_csv outputs/losocv/fold_<PID>/eval_records.csv
```

6) å•æ–‡ä»¶æ£€æµ‹ï¼ˆæ¨ç†ï¼‰

```
python -m src.predict --edf path/to/file.edf --checkpoint outputs/best.pt \
  --config configs/config.yaml --labels_json outputs/labels.json \
  --out outputs/pred_events.json
```

- è¾“å‡ºï¼šæ˜¯å¦å­˜åœ¨ç™«ç—«äº‹ä»¶ã€æ®µæ•°ã€æ¯æ®µç±»å‹ä¸èµ·æ­¢æ—¶é—´ã€‚
 - æç¤ºï¼šcheckpoint çš„åˆ†ç±»å¤´ç±»åˆ«æ•°å¿…é¡»ä¸æä¾›çš„ `labels.json` ä¸€è‡´ï¼Œå¦åˆ™ä¼šæç¤ºä¸åŒ¹é…é”™è¯¯ã€‚

7) å¤ç°ä¸ç¼“å­˜

- éšæœºç§å­ï¼š`--seed`ï¼ˆè®­ç»ƒè„šæœ¬ï¼‰
- é‡ç®—ç‰¹å¾ï¼šåˆ é™¤ `data_cache/*.npz` åå†æ¬¡è¿è¡Œã€‚

---

## äº”ã€é…ç½®è¯¦è§£ï¼ˆæ‘˜å½•ï¼‰

`configs/config.yaml`

```
train:
  # å«æœ‰ EDF/TSE æˆå¯¹æ–‡ä»¶çš„æ•°æ®æ ¹ç›®å½•
  data_dir: data/Dataset_train_dev
  # ç‰¹å¾ç¼“å­˜ç›®å½•ï¼ˆå­˜æ”¾ .npzï¼ŒåŠ é€Ÿå¤ç”¨ï¼‰
  cache_dir: data_cache
  # ç‰¹å¾æ»‘çª—é•¿åº¦ï¼ˆç§’ï¼‰
  window_sec: 2.0
  # ç‰¹å¾æ»‘çª—æ­¥é•¿ï¼ˆç§’ï¼‰
  hop_sec: 0.25
  # è¯»å–åç»Ÿä¸€é‡é‡‡æ ·çš„é¢‘ç‡ï¼ˆHzï¼‰
  resample_hz: 256.0
  # é¢„å¤„ç†å¸¦é€šèŒƒå›´ï¼ˆHzï¼‰ï¼›æŸç«¯ç½®ä¸º null å¯é€€åŒ–ä¸ºé«˜é€š/ä½é€šæˆ–ä¸å¯ç”¨
  bandpass: [0.5, 45.0]
  # å·¥é¢‘é™·æ³¢ï¼ˆ50 æˆ– 60ï¼‰ï¼›ç½®ä¸º null ä¸å¯ç”¨
  notch_hz: 50.0
  # èƒŒæ™¯ç±»åç§°ï¼ˆéœ€ä¸ .tse æˆ–åˆ«åæ˜ å°„ä¸€è‡´ï¼‰
  bg_label: bckg
  
  # ğŸ”§ æ·±åº¦å†…å­˜ä¼˜åŒ–é…ç½®
  batch_size: 1                    # æå°æ‰¹å¤„ç†é¿å…OOM
  gradient_accumulation_steps: 8   # æ¢¯åº¦ç´¯ç§¯ä¿æŒç­‰æ•ˆæ‰¹å¤§å°
  
  # è®­ç»ƒè½®æ¬¡
  epochs: 20
  # æŒ‰ç—…äººåˆ’åˆ†çš„éªŒè¯/æµ‹è¯•æ¯”ä¾‹
  val_ratio: 0.2
  test_ratio: 0.0
  # éšæœºç§å­ï¼ˆå¤ç°ï¼‰
  seed: 42
  # è¾“å‡ºç›®å½•ï¼ˆæ—¥å¿—/æƒé‡/TensorBoardï¼‰
  out_dir: outputs
  
  # ğŸ”§ æ·±åº¦å†…å­˜ä¼˜åŒ–ï¼šå‡å°‘å¹¶å‘å’Œé¢„è®¡ç®—
  num_workers: 0                   # å‡å°‘å¤šè¿›ç¨‹å†…å­˜å¼€é”€
  precompute_cache: none          # å…³é—­é¢„è®¡ç®—å‡å°‘å†…å­˜å ç”¨
  # å›ºå®šåˆ’åˆ†æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰ï¼šå¦‚è®¾ç½®ï¼Œå°†æŒ‰æ­¤åˆ’åˆ†ä½¿ç”¨ train/val/test çš„ record_id åˆ—è¡¨
  splits_json: outputs/splits.json
  # åˆ†å±‚ç­–ç•¥ï¼ˆnone|has_seizure|multiclassï¼‰ï¼šæŒ‰æ‚£è€…åˆ†ç»„çš„åˆ†å±‚åˆ’åˆ†ï¼Œé»˜è®¤å¤šåˆ†ç±»æŒ‰ç±»è¦†ç›–åˆ†å±‚
  stratify: multiclass
  # ç»ˆç«¯è®­ç»ƒè¿›åº¦æ˜¾ç¤ºï¼ˆnone|barï¼‰ä¸æ—¥å¿—é—´éš”ï¼ˆiter çº§æ—¥å¿—é»˜è®¤å…³é—­ï¼Œepoch æ±‡æ€»æ€»ä¼šæ‰“å°ï¼‰
  progress: none
  log_interval: 0
  # æ˜¯å¦åœ¨è®­ç»ƒå‰å…ˆåšä¸€æ¬¡åŸºçº¿éªŒè¯ï¼ˆé»˜è®¤å…³é—­ï¼‰
  eval_at_start: false
 

  # å­¦ä¹ ç‡è°ƒåº¦ä¸æ•°æ®å¢å¼º
  # å»ºè®®ï¼šå°ä¸­å‹æ•°æ®é›†å¯é€‰ onecycleï¼›ä¹Ÿå¯ç”¨ none/cosine
  scheduler: onecycle  # å¯é€‰ï¼šnone|cosine|onecycle
  max_lr: 0.001
  # å½“æœªæä¾› Excel/labels.json æ—¶ï¼Œå¯ä» TSE è‡ªåŠ¨æ¨å¯¼æ ‡ç­¾é›†åˆ
  auto_labels_from_tse: true
  # æ¢¯åº¦è£å‰ªé˜ˆå€¼ï¼ˆ0 è¡¨ç¤ºä¸è£å‰ªï¼‰
  clip_grad: 0.0
  # Mixup å¼ºåº¦ï¼ˆ>0 å¼€å¯å¸§çº§è½¯æ ‡ç­¾æ··åˆï¼‰
  mixup_alpha: 0.0
  # SpecAugment é®æŒ¡ï¼ˆ0 è¡¨ç¤ºä¸å¯ç”¨ï¼‰
  spec_time_mask_ratio: 0.0
  spec_time_masks: 0
  spec_feat_mask_ratio: 0.0
  spec_feat_masks: 0
  # ç‰¹å¾çº§é«˜æ–¯å™ªå£°å¼ºåº¦
  aug_noise_std: 0.0
  # å¸§æ ‡æ³¨ï¼šçª—å£-æ ‡ç­¾é‡å æ¯”ä¾‹é˜ˆå€¼ï¼ˆ0~1ï¼‰ä¸æœ€å°æ®µæ—¶é•¿ï¼ˆç§’ï¼‰
  label_overlap_ratio: 0.2
  min_seg_duration: 0.0

postprocess:
  # åŸºäº 1 - p(background) çš„åˆ¤å®šé˜ˆå€¼
  prob: 0.8
  # æ¦‚ç‡å¹³æ»‘çª—å£ï¼ˆç§’ï¼‰
  smooth: 0.25
  # äº‹ä»¶ç¡®è®¤æ‰€éœ€çš„è¿ç»­å¸§æ•°
  confirm: 2
  # å†·å´åˆå¹¶æ—¶é—´ï¼ˆç§’ï¼ŒåŒç±»ç›¸é‚»äº‹ä»¶åœ¨æ­¤é—´éš”å†…åˆå¹¶ï¼‰
  cooldown: 0.5
  # æœ€çŸ­äº‹ä»¶æ—¶é•¿ï¼ˆç§’ï¼Œä½äºæ­¤é˜ˆå€¼ä¸¢å¼ƒï¼‰
  min_duration: 0.0

labels:
  # èƒŒæ™¯ç±»åç§°ï¼ˆéœ€ä¸ train.bg_label ä¿æŒä¸€è‡´ï¼‰
  background: bckg
  # Excel è¡¨ï¼ˆå–ç¬¬ä¸€ä¸ª sheetï¼‰ï¼šæ¯è¡Œå‰ä¸¤ä¸ªéç©ºå•å…ƒæ ¼è§†ä¸º (label, alias)
  excel_types: <path_to_types.xlsx>
  excel_periods: <path_to_periods.xlsx>
  # è®­ç»ƒ/è¯„ä¼°/æ¨ç†å…±ç”¨çš„æ ‡ç­¾ä¸åˆ«åå¯¼å‡ºæ–‡ä»¶
  json_out: <path_to_labels.json>
```

è¦ç‚¹è¯´æ˜ï¼š

- `window_sec/hop_sec` æ§åˆ¶æ—¶é—´åˆ†è¾¨ç‡ä¸è®¡ç®—é‡ï¼›`resample_hz` å»ºè®®ä¸æ•°æ®æ¥è¿‘çš„é¢‘ç‡ï¼ˆå¦‚ 256Hzï¼‰ã€‚
- `bandpass/notch_hz` ç”¨äºæŠ‘åˆ¶åŸºçº¿æ¼‚ç§»ä¸å·¥é¢‘å™ªå£°ï¼›æ ¹æ®å®éªŒç¯å¢ƒï¼ˆ50/60Hzï¼‰è°ƒæ•´ã€‚
- è°ƒåº¦å™¨ï¼š`onecycle` åœ¨ä¸­å°æ•°æ®é›†ä¸Šé€šå¸¸æ›´ç¨³å®šï¼›`cosine` ç®€æ´æœ‰æ•ˆã€‚
- å¢å¼ºï¼š`mixup_alpha>0` å¼€å¯å¸§çº§è½¯æ ‡ç­¾æ··åˆï¼›SpecAugment ç”¨äºæ—¶é—´/ç‰¹å¾ç»´é®æŒ¡ï¼›`aug_noise_std` è½»åº¦é«˜æ–¯å™ªå£°ã€‚
- é¢„çƒ­ç¼“å­˜ï¼š`precompute_cache` æ§åˆ¶é¢„å…ˆæ„å»º `data_cache/*.npz` çš„èŒƒå›´ï¼›å½“ `num_workers>0` æ—¶é¢„çƒ­ä¸è®­ç»ƒ/éªŒè¯åŠ è½½å‡ä¼šå¹¶è¡Œæ‰§è¡Œã€‚
- åå¤„ç†ï¼š`prob` è¶Šé«˜è¶Šä¿å®ˆï¼ˆå‡å°‘ FPï¼‰ï¼›`confirm/cooldown/min_duration` æ§åˆ¶äº‹ä»¶ç¢ç‰‡åŒ–ä¸è¯¯æŠ¥ã€‚
 - æ ‡ç­¾ï¼šè‹¥æœªæä¾› Excel/`labels.json` ä¸”å¼€å¯ `train.auto_labels_from_tse=true`ï¼Œè®­ç»ƒä¼šå…ˆæ‰«æ `.tse` ä¸­å‡ºç°çš„ï¼ˆéèƒŒæ™¯ï¼‰æ ‡ç­¾å¹¶è‡ªåŠ¨æ„å»ºæ ‡ç­¾é›†åˆï¼›æ¨¡æ¿ä¸­çš„ Excel è·¯å¾„ä»…ä¸ºç¤ºä¾‹ï¼Œå¦‚æ— å®é™…æ–‡ä»¶è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„è·¯å¾„æˆ–ç§»é™¤è¯¥å­—æ®µä»¥é¿å…æŠ¥é”™ã€‚

---

## å…­ã€ğŸ§  ç‰¹å¾ä¸æ³¨æ„åŠ›æ¨¡å‹ï¼ˆè¯¦ç»†æ¶æ„ï¼‰

### ğŸ“Š **EEGç‰¹å¾æå–**
- **é¢‘å¸¦åˆ†æ**ï¼šdelta(0.5â€“4)ã€theta(4â€“8)ã€alpha(8â€“13)ã€beta(13â€“30)ã€gamma(30â€“45)
- **æ¯å¸§ç‰¹å¾**ï¼ˆ14ç»´ï¼‰ï¼š  
  - 5ä¸ªé¢‘å¸¦åŠŸç‡ {mean, std} â†’ 10ç»´  
  - å®½é¢‘èƒ½é‡ {mean, std} â†’ 2ç»´  
  - æ—¶åŸŸRMS {mean, std} â†’ 2ç»´  

### ğŸ§  **å¤šå°ºåº¦æ³¨æ„åŠ›BiLSTMæ¶æ„**
```python
# å®Œæ•´å‰å‘ä¼ æ’­æµç¨‹
1. é€šé“æ³¨æ„åŠ›: [B,T,14] â†’ çªå‡ºé‡è¦é¢‘å¸¦
2. BiLSTMéª¨å¹²: [B,T,14] â†’ [B,T,256] (hidden_dim*2)
3. æ—¶é—´æ³¨æ„åŠ›: [B,T,256] â†’ èšç„¦å…³é”®æ—¶åˆ» + æ®‹å·®è¿æ¥
4. åˆ†ç±»å™¨: [B,T,256] â†’ [B,T,C] å¸§çº§logits
```

### ğŸ“ˆ **æ¨¡å‹å‚æ•°ç»Ÿè®¡**
- **æ€»å‚æ•°é‡**: ~0.85Mï¼ˆå†…å­˜ä¼˜åŒ–ç‰ˆï¼‰
- **é€šé“æ³¨æ„åŠ›**: 84å‚æ•° (0.01%)
- **BiLSTM**: 0.64Må‚æ•° (75.5%)
- **æ—¶é—´æ³¨æ„åŠ›**: 0.18Må‚æ•° (21.2%)
- **åˆ†ç±»å™¨**: 0.03Må‚æ•° (3.5%)

### ğŸ”§ **æ•°æ®å¢å¼º**ï¼ˆå¯é…ç½®ï¼‰
- **Mixup**: åŒbatchå†…æŒ‰Beta(Î±,Î±)çº¿æ€§æ··åˆç”Ÿæˆè½¯ç›®æ ‡
- **SpecAugment**: éšæœºæ—¶é—´æ®µ/ç‰¹å¾é¢‘æ®µç½®é›¶ï¼Œæ¨¡æ‹Ÿä¿¡å·ä¸¢å¤±
- **å™ªå£°æ‰°åŠ¨**: å¯¹ç‰¹å¾æ–½åŠ å°å¹…é«˜æ–¯å™ªå£°
- **å½“å‰é…ç½®**: æ‰€æœ‰å¢å¼ºå·²å…³é—­ä»¥èŠ‚çœå†…å­˜

---

## ä¸ƒã€æŒ‡æ ‡ä¸åå¤„ç†

- IoU åŒ¹é…ï¼špred ä¸ gt ç‰‡æ®µçš„åŒºé—´ IoUâ‰¥é˜ˆå€¼ä¸”ç±»åˆ«ä¸€è‡´ â†’ TPï¼›æœªåŒ¹é…çš„ pred ä¸º FPï¼ŒæœªåŒ¹é…çš„ gt ä¸º FNã€‚
- P/R/F1ï¼šæŒ‰ç´¯è®¡ TP/FP/FN è®¡ç®—ï¼›æ”¯æŒå¤š IoUï¼ˆ`--ious`ï¼‰ã€‚
- FA/hï¼š`FP / æ€»å°æ—¶`ï¼Œç”¨äºè¯¯æŠ¥è­¦ç‡æ§åˆ¶ï¼ˆé˜ˆå€¼ç½‘æ ¼æ—¶å¯ç”¨ `--max_fa_per_hour` çº¦æŸï¼‰ã€‚
- èµ·æ­¢å»¶è¿Ÿï¼šåŒ¹é…å¯¹çš„ |Î”onset| / |Î”offset| å¹³å‡ã€‚
- åå¤„ç†æµæ°´ï¼šå¹³æ»‘ â†’ äºŒå€¼åŒ– â†’ ç¡®è®¤çª—è¿‡æ»¤ â†’ å†·å´åˆå¹¶ â†’ æœ€å°æ—¶é•¿è¿‡æ»¤ï¼›ç‰‡æ®µç±»åˆ«ä»¥å¸§æ¦‚ç‡å’Œï¼ˆæˆ–æœ€å¤§ï¼‰å–ä¸»ç±»ã€‚

### æ±‡æ€»å£å¾„ï¼ˆLOSOCVï¼‰
- å®å¹³å‡ï¼ˆmacroï¼‰ï¼šå¯¹å„æŠ˜æŒ‡æ ‡ï¼ˆP/R/F1ï¼‰åšç®€å•å¹³å‡ï¼Œå…¬å¹³åæ˜ è·¨å—è¯•è€…æ³›åŒ–ã€‚
- å¾®å¹³å‡ï¼ˆmicroï¼‰ï¼šç´¯åŠ  TP/FP/FN ä¸æ€»æ—¶é•¿è®¡ç®—æ•´ä½“ P/R/F1 ä¸ FA/hï¼Œåæ˜ æ€»ä½“è¿è¡Œç‚¹ã€‚

æ±‡æ€»æ–‡ä»¶ï¼š`outputs/losocv/loso_eval_aggregate.json`ã€‚

---

## å…«ã€é¡¹ç›®ç»“æ„

- `src/edf_reader.py`ï¼šEDF è¯»å–ã€æ»¤æ³¢/é™·æ³¢ã€é‡é‡‡æ ·ã€å¯¹é½
- `src/features.py`ï¼šè°±åŠŸç‡ä¸æ—¶åŸŸç‰¹å¾
- `src/dataset.py`ï¼šæ•°æ®é›†ä¸ `.npz` ç¼“å­˜
- `src/model.py`ï¼š`BiLSTMClassifier`
- `src/postprocess.py`ï¼šå¹³æ»‘/ç¡®è®¤/å†·å´/æ—¶é•¿è¿‡æ»¤
- `src/metrics.py`ï¼šIoU åŒ¹é…ã€P/R/F1ã€FA/hã€å»¶è¿Ÿ
- `src/scan_thresholds.py`ï¼šé˜ˆå€¼ç½‘æ ¼ã€FA/h çº¦æŸã€å†™å›é…ç½®
- `src/eval.py`ï¼šä» checkpoint è¯„ä¼°ï¼Œè¾“å‡º JSON/CSV
- `src/train.py`ï¼šè®­ç»ƒï¼ˆé…ç½®ã€æ—¥å¿—ã€TBã€schedulerã€augmentã€checkpointï¼‰
- `configs/config.yaml`ï¼šé…ç½®æ¨¡æ¿
- `data/`ã€`data_cache/`ã€`outputs/`ï¼šæ•°æ®/ç¼“å­˜/ç»“æœç›®å½•ï¼ˆå·²å¿½ç•¥ï¼‰

---

## ä¹ã€OOMå†…å­˜æº¢å‡ºè§£å†³æ–¹æ¡ˆè¯¦è§£

### ğŸš¨ **é—®é¢˜èƒŒæ™¯**

EEGæ•°æ®å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹å¯¼è‡´OOMé—®é¢˜ï¼š
- **é•¿åºåˆ—**: å•ä¸ªEEGæ–‡ä»¶å¯è¾¾æ•°å°æ—¶ï¼Œäº§ç”Ÿæ•°ä¸‡å¸§ç‰¹å¾
- **å¤šé€šé“**: é€šå¸¸20ä¸ªé€šé“åŒæ—¶è®°å½•
- **é«˜é‡‡æ ·ç‡**: 256Hzé‡‡æ ·ç‡äº§ç”Ÿå¤§é‡æ•°æ®ç‚¹
- **æ‰¹å¤„ç†**: å¤šä¸ªé•¿åºåˆ—åŒæ—¶åŠ è½½åˆ°å†…å­˜

### âœ… **å†…ç½®OOMä¿æŠ¤æœºåˆ¶**

#### **1. æ™ºèƒ½æ‰¹å¤„ç†ä¼˜åŒ–**
```python
# è‡ªåŠ¨åºåˆ—é•¿åº¦é™åˆ¶
MAX_SEQUENCE_LENGTH = 8000  # çº¦33åˆ†é’Ÿï¼Œé˜²æ­¢å•åºåˆ—è¿‡é•¿

# å†…å­˜é¢„æ£€æŸ¥
estimated_memory_mb = (batch_size * max_seq_len * features * 4) / (1024 * 1024)
if estimated_memory_mb > 800:  # è¶…è¿‡800MBè‡ªåŠ¨è°ƒæ•´
    # åŠ¨æ€ç¼©å‡åºåˆ—é•¿åº¦
```

#### **2. æ¢¯åº¦ç´¯ç§¯æŠ€æœ¯**
```bash
# ç­‰æ•ˆå¤§æ‰¹æ¬¡è®­ç»ƒï¼Œä½†å†…å­˜å‹å¥½
batch_size: 2                    # å®é™…æ‰¹æ¬¡å¤§å°
gradient_accumulation_steps: 2   # ç´¯ç§¯2æ­¥ = ç­‰æ•ˆbatch_size=4
```

#### **3. å†…å­˜ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†**
```python
# è®­ç»ƒä¸­è‡ªåŠ¨ç›‘æ§GPUå†…å­˜
if memory_used_gb > 6.0:
    torch.cuda.empty_cache()  # è‡ªåŠ¨æ¸…ç†

# OOMå¼‚å¸¸æ•è·å’Œæ¢å¤
except RuntimeError as e:
    if "out of memory" in str(e):
        # è‡ªåŠ¨è·³è¿‡é—®é¢˜æ‰¹æ¬¡ï¼Œç»§ç»­è®­ç»ƒ
```

#### **4. ç‰¹å¾æå–ä¼˜åŒ–**
```python
# é¢„åˆ†é…æ•°ç»„ï¼Œé¿å…åŠ¨æ€å¢é•¿
X = np.zeros((n_frames, n_features), dtype=np.float32)

# åŠæ—¶é‡Šæ”¾ä¸´æ—¶å˜é‡
del psd_array, seg, rms
```

### ğŸ›ï¸ **å†…å­˜é…ç½®çº§åˆ«**

#### **Level 1: æ ‡å‡†é…ç½®ï¼ˆ8GB+ å†…å­˜ï¼‰**
```bash
python -m src.train --config configs/config.yaml
# batch_size=2, gradient_accumulation_steps=2, num_workers=1
```

#### **Level 2: èŠ‚çº¦é…ç½®ï¼ˆ4-8GB å†…å­˜ï¼‰**
```bash
python -m src.train --batch_size 1 --gradient_accumulation_steps 4 --num_workers 0
```

#### **Level 3: æé™é…ç½®ï¼ˆ<4GB å†…å­˜ï¼‰**
```bash
python -m src.train --batch_size 1 --gradient_accumulation_steps 1 --num_workers 0 --epochs 5
```

### ğŸ“Š **ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**

| é…ç½®é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å†…å­˜èŠ‚çœ |
|--------|--------|--------|----------|
| æ‰¹æ¬¡å¤§å° | 4 | 2 | 50% |
| åºåˆ—é•¿åº¦ | æ— é™åˆ¶ | 8000å¸§ | 70% |
| å¤šè¿›ç¨‹ | 4 workers | 1 worker | 75% |
| é¢„è®¡ç®— | first_batch | none | 30% |
| æ€»ä½“æ•ˆæœ | 16GB+ | 3-6GB | **60-80%** |

### ğŸ”§ **æ•…éšœæ’é™¤**

#### **ä»ç„¶é‡åˆ°OOMï¼Ÿ**
```bash
# 1. æ£€æŸ¥åºåˆ—é•¿åº¦åˆ†å¸ƒ
python -c "
from src.utils import pair_edf_tse
from src.dataset import SequenceDataset
pairs = pair_edf_tse('data/Dataset_train_dev')[:5]
for edf, tse, rec in pairs:
    print(f'{rec}: é•¿åº¦å¾…æ£€æŸ¥')
"

# 2. ä½¿ç”¨æœ€ä¿å®ˆé…ç½®
python -m src.train \
  --batch_size 1 \
  --gradient_accumulation_steps 1 \
  --num_workers 0 \
  --epochs 3

# 3. ç›‘æ§å†…å­˜ä½¿ç”¨
# è®­ç»ƒæ—¶è§‚å¯Ÿè¾“å‡ºä¸­çš„å†…å­˜è­¦å‘Šä¿¡æ¯
```

#### **æ€§èƒ½ä¼˜åŒ–å»ºè®®**
- âœ… ä½¿ç”¨GPUåŠ é€Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰
- âœ… å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
- âœ… åˆç†è®¾ç½® `num_workers`ï¼ˆWindowså»ºè®®1ï¼ŒLinuxå¯ä»¥2-4ï¼‰
- âœ… ç›‘æ§ `data_cache/` å¤§å°ï¼Œå®šæœŸæ¸…ç†

---

## åã€å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### ğŸ”§ **å®‰è£…é—®é¢˜**
- **SciPy/pyEDFlib å®‰è£…å¤±è´¥**ï¼šå»ºè®®åœ¨ conda ç¯å¢ƒä¸‹å®‰è£…ç›¸åº”äºŒè¿›åˆ¶åŒ…ï¼›æˆ–ä½¿ç”¨ä¸ Python ç‰ˆæœ¬åŒ¹é…çš„ whlã€‚
- **torch æ¨¡å—æ‰¾ä¸åˆ°**ï¼šç¡®ä¿å·²æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ `conda activate EEG_work`

### ğŸ’¾ **å†…å­˜/OOMé—®é¢˜**
- **è®­ç»ƒOOM**: æœ¬é¡¹ç›®å·²å†…ç½®OOMä¿æŠ¤ï¼Œå¦‚ä»æœ‰é—®é¢˜ï¼š
  ```bash
  # æœ€å°å†…å­˜é…ç½®
  python -m src.train --batch_size 1 --gradient_accumulation_steps 4 --num_workers 0
  ```
- **ç‰¹å¾æå–OOM**: åˆ é™¤ `data_cache/*.npz` é‡æ–°ç”Ÿæˆï¼Œä½¿ç”¨ä¼˜åŒ–åçš„ç‰¹å¾æå–
- **GPUå†…å­˜ä¸è¶³**: è‡ªåŠ¨å¯ç”¨CPUè®­ç»ƒï¼Œæˆ–ä½¿ç”¨ `memory_efficient=True` æ¨¡å¼

### ğŸªŸ **Windowsç‰¹æœ‰é—®é¢˜**
- **å¤šè¡Œå‘½ä»¤æ‰§è¡Œå¤±è´¥**: Windows PowerShellä¸æ”¯æŒ `\` ç»­è¡Œï¼Œä½¿ç”¨å•è¡Œå‘½ä»¤æˆ–åå¼•å·ç»­è¡Œï¼š
  ```powershell
  # æ­£ç¡®çš„PowerShellè¯­æ³•
  python -m src.losocv `
      --config configs/config.yaml `
      --run_train --batch_size 2
  ```
- **ç¯å¢ƒæ¿€æ´»**: æ¯æ¬¡æ‰“å¼€ç»ˆç«¯éƒ½éœ€è¦ `conda activate EEG_work`

### ğŸ“Š **è®­ç»ƒå’Œè¯„ä¼°é—®é¢˜**
- **LOSOCVä¸­æ–­ç»­è®­**: ä½¿ç”¨ `--resume` å‚æ•°è‡ªåŠ¨ä»æ–­ç‚¹ç»§ç»­
- **æŒ‡æ ‡å¼‚å¸¸**ï¼š
  - æ£€æŸ¥ `bg_label` æ˜¯å¦ä¸æ•°æ®ä¸€è‡´
  - ç¡®è®¤ TSE è§£æä¸æ—¶é—´å•ä½
  - æŸ¥éªŒåå¤„ç†é˜ˆå€¼æ˜¯å¦å·²å†™å›å¹¶è¢«è¯„ä¼°è„šæœ¬æ­£ç¡®åŠ è½½
- **ç¼“å­˜å†²çª**: ä¿®æ”¹ç‰¹å¾/æ»¤æ³¢å‚æ•°åå»ºè®®åˆ é™¤æ—§çš„ `data_cache/*.npz` ä»¥å…æ··ç”¨

### ğŸ¯ **æ€§èƒ½ä¼˜åŒ–å»ºè®®**
- **è®­ç»ƒå¤ªæ…¢**: ä½¿ç”¨ `--progress bar` æŸ¥çœ‹è¿›åº¦ï¼Œç¡®ä¿GPU/CUDAå¯ç”¨
- **æ•°æ®åŠ è½½æ…¢**: æ£€æŸ¥ `num_workers` è®¾ç½®ï¼ŒWindowså»ºè®®è®¾ä¸º1
- **å†…å­˜ä½¿ç”¨ç›‘æ§**: è®­ç»ƒæ—¶ä¼šè‡ªåŠ¨æ˜¾ç¤ºå†…å­˜è­¦å‘Šå’Œä½¿ç”¨æƒ…å†µ

---

## åä¸€ã€è®¸å¯ä¸è‡´è°¢

- è®¸å¯ï¼šè§æ ¹ç›®å½• `LICENSE`ã€‚
- è‡´è°¢ï¼šæ„Ÿè°¢å¼€æºç¤¾åŒºï¼ˆpyEDFlibã€SciPyã€PyTorchã€TensorBoard ç­‰ï¼‰æä¾›çš„ç”Ÿæ€æ”¯æŒã€‚
 - æ•°æ®é›†ï¼šæ„Ÿè°¢ Temple University Hospital Seizure Corpusï¼ˆTUSZï¼‰æä¾›çš„æ•°æ®ä¸æ ‡æ³¨ï¼Œå‚è€ƒå…¶[å®˜æ–¹ä¸»é¡µ](https://www.isip.piconepress.com/projects/tuh_eeg/html/downloads.shtml)ã€‚
